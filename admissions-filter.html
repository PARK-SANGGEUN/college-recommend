<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>입시 결과 필터 앱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo } = React;

      function AdmissionsFilterApp() {
        const [rawRows, setRawRows] = useState([]);
        const [fileName, setFileName] = useState("");
        const [error, setError] = useState("");

        const [year, setYear] = useState("2025"); // 학년도 기본 2025
        const [track, setTrack] = useState("");
        const [region, setRegion] = useState("");
        const [scheme, setScheme] = useState("");
        const [scoreType, setScoreType] = useState("국영수");
        const [cutoff, setCutoff] = useState("");
        const [unitQuery, setUnitQuery] = useState("");

        function extractRegion(univ) {
          const m = /\(([^)]+)\)/.exec(String(univ || ""));
          return m ? m[1].trim() : "";
        }

        function extractScheme(subtype) {
          const s = String(subtype || "");
          if (s.includes("교과")) return "교과전형";
          if (s.includes("종합")) return "종합전형";
          return "기타";
        }

        function parseScore(raw) {
          const text = String(raw ?? "").trim();
          const num = Number(text.replace(/[^\d.\-]/g, ""));
          return { num, text };
        }

        function handleUpload(ev) {
          const file = ev.target.files?.[0];
          if (!file) return;
          setError("");
          setFileName(file.name);
          const ext = file.name.split(".").pop()?.toLowerCase();

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              let wb;
              if (ext === "csv") {
                // CSV는 텍스트로 파싱
                const text = e.target.result;
                wb = XLSX.read(text, { type: "string" });
              } else {
                // XLSX/XLS 등은 ArrayBuffer로 파싱
                const data = e.target.result;
                wb = XLSX.read(data, { type: "array" });
              }
              const ws = wb.Sheets[wb.SheetNames[0]];
              const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
              setRawRows(Array.isArray(json) ? json : []);
            } catch (err) {
              console.error(err);
              setError("파일 파싱 중 오류가 발생했습니다. 엑셀 첫 행에 헤더가 있는지 확인해주세요.");
              setRawRows([]);
            } finally {
              // 같은 파일 재업로드 가능하도록 초기화
              ev.target.value = "";
            }
          };

          if (ext === "csv") reader.readAsText(file, "utf-8");
          else reader.readAsArrayBuffer(file);
        }

        const filtered = useMemo(() => {
          if (!rawRows.length) return [];

          const okResults = new Set(["합격", "충원합격"]);
          const cutoffNum = cutoff === "" ? Number.POSITIVE_INFINITY : Number(cutoff);

          const needle = unitQuery.trim();
          const enableUnit = needle.length >= 2;
          const needleLower = needle.toLowerCase();

          return rawRows.filter((r) => {
            if (String(r["학년도"] ?? "").trim() !== year) return false;
            if (!okResults.has(String(r["합불"] ?? "").trim())) return false;

            if (track && String(r["계열"] ?? "").trim() !== track) return false;
            if (region && extractRegion(String(r["대학명"] ?? "")) !== region) return false;
            if (scheme && extractScheme(String(r["세부유형"] ?? "")) !== scheme) return false;

            if (enableUnit) {
              const u = String(r["모집단위"] ?? "");
              if (!u.toLowerCase().includes(needleLower)) return false;
            }

            let scoreCol = null;
            if (scoreType === "국영수") scoreCol = "국영수";
            if (scoreType === "국수영사") scoreCol = "국수영사";
            if (scoreType === "국영수과") scoreCol = "국영수과";

            if (scoreCol) {
              const { num, text } = parseScore(r[scoreCol]);
              if (text === "") return false;
              if (!Number.isFinite(num)) return false;
              if (num > cutoffNum) return false;
            }
            return true;
          });
        }, [rawRows, year, track, region, scheme, scoreType, cutoff, unitQuery]);

        const resultRows = useMemo(() => {
          const rows = filtered.map((r, i) => {
            const { num, text } = parseScore(r[scoreType]);
            return {
              id: i + 1,
              대학명: String(r["대학명"] ?? ""),
              세부유형: String(r["세부유형"] ?? ""),
              모집단위: String(r["모집단위"] ?? ""),
              성적: text,
              _scoreNum: num,
            };
          });
          // 성적 내림차순
          return rows.sort((a, b) => {
            const ax = Number.isFinite(a._scoreNum) ? a._scoreNum : -Infinity;
            const bx = Number.isFinite(b._scoreNum) ? b._scoreNum : -Infinity;
            return bx - ax;
          });
        }, [filtered, scoreType]);

        function uniqueTrack() {
          return Array.from(new Set(rawRows.map((r) => String(r["계열"] ?? "").trim()).filter(Boolean)));
        }

        function uniqueRegion() {
          return Array.from(new Set(rawRows.map((r) => extractRegion(String(r["대학명"] ?? ""))).filter(Boolean)));
        }

        function uniqueScheme() {
          return Array.from(new Set(rawRows.map((r) => extractScheme(String(r["세부유형"] ?? ""))).filter(Boolean)));
        }

        return (
          <div className="min-h-screen p-6">
            <div className="max-w-6xl mx-auto space-y-6">
              <header className="flex items-center justify-between">
                <h1 className="text-2xl font-bold">입시 결과 필터 앱</h1>
              </header>

              <section className="bg-white rounded-2xl shadow p-5">
                <label className="block text-sm font-medium mb-2">데이터 파일 업로드</label>
                <input type="file" accept=".xlsx,.xls,.csv" onChange={handleUpload} className="block w-full text-sm" />
                <div className="mt-2 text-sm text-gray-600">
                  {fileName ? <>선택된 파일: <b>{fileName}</b></> : "선택된 파일 없음"}
                </div>
                <div className="text-sm text-gray-500 mt-1">행 수: {rawRows.length.toLocaleString()}</div>
                {error && <div className="mt-2 p-2 text-sm text-red-700 bg-red-50 border border-red-200 rounded">{error}</div>}
              </section>

              <section className="bg-white rounded-2xl shadow p-5">
                <h2 className="text-lg font-semibold mb-3">검색 조건</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">학년도</label>
                    <input type="text" value={year} onChange={(e) => setYear(e.target.value)} className="w-full border rounded p-2" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">계열</label>
                    <select value={track} onChange={(e) => setTrack(e.target.value)} className="w-full border rounded p-2">
                      <option value="">(전체)</option>
                      {uniqueTrack().map((v) => <option key={v} value={v}>{v}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">지역</label>
                    <select value={region} onChange={(e) => setRegion(e.target.value)} className="w-full border rounded p-2">
                      <option value="">(전체)</option>
                      {uniqueRegion().map((v) => <option key={v} value={v}>{v}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">전형</label>
                    <select value={scheme} onChange={(e) => setScheme(e.target.value)} className="w-full border rounded p-2">
                      <option value="">(전체)</option>
                      {uniqueScheme().map((v) => <option key={v} value={v}>{v}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">성적 종류</label>
                    <select value={scoreType} onChange={(e) => setScoreType(e.target.value)} className="w-full border rounded p-2">
                      <option value="국영수">국영수</option>
                      <option value="국수영사">국수영사</option>
                      <option value="국영수과">국영수과</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">기준 점수 (이하)</label>
                    <input type="number" value={cutoff} onChange={(e) => setCutoff(e.target.value)} className="w-full border rounded p-2" placeholder="예: 3.75" />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">모집단위 (부분검색, 2자 이상)</label>
                    <input type="text" value={unitQuery} onChange={(e) => setUnitQuery(e.target.value)} className="w-full border rounded p-2" placeholder="예: 의예" />
                  </div>
                </div>
                <p className="mt-2 text-xs text-gray-500">※ 모집단위 검색어는 2글자 이상 입력 시 적용됩니다.</p>
              </section>

              <section className="bg-white rounded-2xl shadow p-5">
                <h2 className="text-lg font-semibold mb-3">검색 결과 ({resultRows.length}건) — 성적 내림차순</h2>
                <div className="overflow-auto">
                  <table className="min-w-full text-sm border">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="p-2 border">#</th>
                        <th className="p-2 border">대학명</th>
                        <th className="p-2 border">세부유형</th>
                        <th className="p-2 border">모집단위</th>
                        <th className="p-2 border">성적({scoreType})</th>
                      </tr>
                    </thead>
                    <tbody>
                      {resultRows.map((row, idx) => (
                        <tr key={row.id + "-" + idx} className="odd:bg-white even:bg-gray-50">
                          <td className="p-2 border">{idx + 1}</td>
                          <td className="p-2 border">{row.대학명}</td>
                          <td className="p-2 border">{row.세부유형}</td>
                          <td className="p-2 border">{row.모집단위}</td>
                          <td className="p-2 border">{row.성적}</td>
                        </tr>
                      ))}
                      {resultRows.length === 0 && (
                        <tr>
                          <td colSpan="5" className="p-6 text-center text-gray-500">조건에 맞는 결과가 없습니다.</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </section>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<AdmissionsFilterApp />);
    </script>
  </body>
</html>
